<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VRSG Tap Game</title>
<style>
  body,html{margin:0;padding:0;background:#070710;color:#e6eef6;font-family:sans-serif;user-select:none;}
  canvas{display:block;margin:12px auto;border:2px solid #0f1720;background:#040514;outline:none;}
  #hud{display:flex;justify-content:space-between;max-width:520px;margin:0 auto;padding:6px 12px;color:#9fb6c9;}
  #startOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(2,6,12,0.85);display:flex;align-items:center;justify-content:center;z-index:999;}
  .panel{background:#0b1220;padding:18px;border-radius:10px;min-width:300px;text-align:center;}
  button{background:#12a7ff;color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;}
  button:active{transform:translateY(1px);}
</style>
</head>
<body>
<div id="startOverlay">
  <div class="panel">
    <h2>VRSG Tap Game</h2>
    <p>Press <strong>Enter</strong> or click Start to begin.<br>Use <strong>D F J K</strong> to hit lanes.</p>
    <button id="startBtn">Start</button>
  </div>
</div>

<canvas id="gameCanvas" width="520" height="540" tabindex="0"></canvas>
<div id="hud">
  <div>Score: <span id="score">0</span></div>
  <div>Combo: <span id="combo">0</span></div>
  <div>Misses: <span id="misses">0</span></div>
</div>

<script>
(() => {
  const canvas=document.getElementById('gameCanvas');
  const ctx=canvas.getContext('2d');
  const scoreEl=document.getElementById('score');
  const comboEl=document.getElementById('combo');
  const missesEl=document.getElementById('misses');
  const startOverlay=document.getElementById('startOverlay');
  const startBtn=document.getElementById('startBtn');

  const lanes=4;
  const laneWidth=canvas.width/lanes;
  const keyMap=['d','f','j','k'];
  const laneColors=[{fill:'#00bcd4',rim:'#083238'},{fill:'#ff9f1c',rim:'#3a1f04'},{fill:'#57d84b',rim:'#12350a'},{fill:'#ff4d9e',rim:'#3a0a21'}];

  let notes=[];
  let score=0, combo=0, misses=0;
  const hitLineY=canvas.height-120;
  const hitWindow=40;
  const speed=8;
  let gameStarted=false;
  const pressedKeys={};

  function createNotes(){
    notes=[];
    let y=-60;
    for(let i=0;i<80;i++){
      const lane=Math.floor(Math.random()*lanes);
      notes.push({lane,y,hit:false});
      y-=120 + Math.floor(Math.random()*60);
    }
  }

  function drawCircle(cx,cy,r,color){
    ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.fillStyle=color.fill; ctx.fill();
    ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.lineWidth=4; ctx.strokeStyle=color.rim; ctx.stroke();
  }

  function draw(){
    ctx.fillStyle='#03040a'; ctx.fillRect(0,0,canvas.width,canvas.height);
    for(let i=1;i<lanes;i++){
      ctx.strokeStyle='#0d1620'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(i*laneWidth,0); ctx.lineTo(i*laneWidth,canvas.height); ctx.stroke();
    }
    ctx.strokeStyle='rgba(110,220,255,0.98)'; ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(0,hitLineY); ctx.lineTo(canvas.width,hitLineY); ctx.stroke();

    notes.forEach(n=>{
      if(n.hit) return;
      const cx=n.lane*laneWidth + laneWidth/2;
      drawCircle(cx,n.y,28,laneColors[n.lane]);
    });
  }

  function update(){
    notes.forEach(n=>{
      if(n.hit) return;
      n.y+=speed;
      if(n.y-hitLineY>hitWindow){
        n.hit=true;
        combo=0;
        comboEl.textContent='Combo: '+combo;
        misses++;
        missesEl.textContent='Misses: '+misses;
      }
    });
  }

  function findNearest(lane){
    let best=null,dist=Infinity;
    notes.forEach(n=>{
      if(n.hit) return;
      if(n.lane!==lane) return;
      const d=Math.abs(n.y-hitLineY);
      if(d<dist){dist=d;best=n;}
    });
    return {note:best,dist};
  }

  function handleKeyDown(key){
    const k=key.toLowerCase();
    const lane=keyMap.indexOf(k);
    if(lane===-1) return;
    if(pressedKeys[k]) return;
    pressedKeys[k]=true;

    const {note,dist}=findNearest(lane);
    if(!note){ combo=0; comboEl.textContent='Combo: '+combo; misses++; missesEl.textContent='Misses: '+misses; return; }
    if(dist<=hitWindow){ note.hit=true; combo++; comboEl.textContent='Combo: '+combo; score+=100; scoreEl.textContent='Score: '+score; }
    else{ combo=0; comboEl.textContent='Combo: '+combo; misses++; missesEl.textContent='Misses: '+misses; }
  }

  function handleKeyUp(key){
    pressedKeys[key.toLowerCase()]=false;
  }

  function gameLoop(){
    draw();
    if(gameStarted) update();
    requestAnimationFrame(gameLoop);
  }

  function startGame(){
    if(gameStarted) return;
    startOverlay.style.display='none';
    gameStarted=true;
    canvas.focus();
    createNotes();
  }

  startBtn.addEventListener('click',startGame);
  window.addEventListener('keydown',e=>{
    if(!gameStarted && (e.key==='Enter'||e.key==='Return')){ startGame(); return; }
    handleKeyDown(e.key);
  });
  window.addEventListener('keyup',e=>handleKeyUp(e.key));
  canvas.addEventListener('click',()=>canvas.focus());

  gameLoop();
})();
</script>
</body>
</html>
